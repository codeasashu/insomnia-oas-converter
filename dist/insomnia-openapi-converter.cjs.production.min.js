"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("openapi3-ts");function e(){return(e=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function r(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function n(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return r(t,void 0);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var a=0;return function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=t[Symbol.iterator]()).next.bind(n)}var a=/(?<!\\){([^{}]+)(?<!\\)}/g,i=function(t,e){var r=e.filter((function(e){return e.parentId==t._id}));return r.length?r.pop():null},o=function(t,e){void 0===e&&(e={});var r=(t=t.toString()).matchAll(a);for(var n in r){var i=n[1].trim();t=t.replace(n[0],e[i]||n[0])}return t},s=function(t){return t.includes("http://")||t.includes("https://")},u=function(t){return!1===s(t)&&(t="http://"+t),new URL(function(t,e){void 0===e&&(e=!1);for(var r,i=n((t=t.toString()).matchAll(a));!(r=i()).done;){var o=r.value,s=o[0].replace("{","").replace("}","").trim();t=t.replace(o[0],e?"{"+s+"}":s)}return t}(t))},c=function(t){return t.toLowerCase().trim()},l=require("js-yaml"),p=function(){function t(t){this.spec=t}var e=t.prototype;return e.as_yaml=function(){return l.dump(this.as_dict())},e.as_json=function(t){var e=this.spec.getSpecAsJson();if(!0===t)try{return JSON.stringify(JSON.parse(e),null,2)}catch(t){return console.warn("[JSONss parseerror]",t),e}return e},e.as_dict=function(){return this.spec.getSpec()},t}(),h=require("generate-schema"),d=function(){function r(){this.envVars={},this.builder=new t.OpenApiBuilder}var i=r.prototype;return i.addInfo=function(t){return this.builder.addTitle(t.title),this.builder.addDescription(t.description),this.builder.addVersion(t.version),this.add_url(t.baseUrl),this},i.getRequestFromOas=function(e,r){var n=t.getPath(this.builder.rootDoc.paths,e);return n&&n[r]||null},i.addFolderToRequest=function(t,e){if(e){var r={name:t.name};this.builder.addTag(r),this.updateRequest(e,{tags:[r.name]})}return this},i.addEnvironment=function(t){return this.envVars=e({},this.envVars,t),this},i.updateRequest=function(t,r){var n=c(t.method),a=this.get_path_pathparams(t.url).path,i=this.getRequestFromOas(a,n);if(i){var o,s=((o={})[n]=Object.assign({},i,e({},r)),o);this.builder.addPath(a,s)}},i.get_path_pathparams=function(t){var e=this._get_oas_pathparams(t);if(null===e)throw Error("Valid path is missing from request!");return{path:e.path,params:e.params}},i.addRequest=function(t){var e={summary:t.name,description:t.description},r=c(t.method),n=this.insomnia_to_oas_params(t.headers,"header"),a=this.get_path_pathparams(t.url),i=this.get_query_params(t);e[r]={parameters:[].concat(n,a.params,i)},e[r]["x-request-id"]=t._id,0!==Object.keys(t.body).length&&(e[r].requestBody=this.get_request_body(t.body));var o=this.get_responses(t.examples);return e[r].responses=o,this.builder.addPath(a.path,e),this},i.get_responses=function(t){for(var r,a={},i={content:{}},o=n(t);!(r=o()).done;){var s,u=r.value,c=void 0,l=u.body;if("application/json"===u.contentType){var p="";try{p=JSON.parse(l)}catch(t){console.info("Response :: Error parsing json body. Using string instead"),p=l}finally{c=this._get_schema(p)}}else c=this._get_schema(l);var h=Object.assign({},i.content[u.contentType]),d=h&&h.schema;h.schema=d?{oneOf:[].concat(c,d)}:c;var f=((s={})[u.id]=u.body,s);h.examples=e({},f,h.examples),i.content[u.contentType]=h,a[u.statusCode.toString()]=i}return a},i.get_request_body=function(t){var e,r,a={content:{}};if("application/json"===t.mimeType){var i={};try{i=JSON.parse(t.text)}catch(e){console.info("RequestBody :: Error parsing json body. Using string instead"),i=t.text}finally{e=this._get_schema(i),r=i}}else if("application/x-www-form-urlencoded"===t.mimeType||"multipart/form-data"===t.mimeType){var o=function(t){for(var e,r={},a=n(t);!(e=a()).done;){var i=e.value;r[i.name]=i.value}return r}(t.params);e=this._get_schema(o),r=o}else e={additionalProperties:!0},r=t.text||t.params||{};return a.content[t.mimeType]={schema:e,example:r},a},i.get_query_params=function(t){var e=this._get_oas_query_params_from_url(t.url),r=this.insomnia_to_oas_params(t.parameters,"query"),n=e.map((function(t){return t.name})),a=r.filter((function(t){return-1===n.indexOf(t.name)}));return[].concat(e,a)},i._get_from_env=function(t){return this.envVars[t]?this.envVars[t]:null},i.add_url=function(t){if(!1===s(t))return this;var e=this.builder.rootDoc.servers;return e?(0===e.filter((function(e){return e.url===t})).length&&this.builder.addServer({url:t}),this):(this.builder.addServer({url:t}),this)},i._get_oas_pathparams=function(t){var e,r="",i=[];try{var s=u(t);this.add_url(s.origin);for(var c,l=n((e=(r=decodeURIComponent(s.pathname)).toString().matchAll(a),Array.from(e).map((function(t){return t[1].trim()}))));!(c=l()).done;){var p=c.value;i.push({name:p,in:"path",example:o(p,this.envVars),schema:this._get_schema(p)})}}catch(t){return console.error(t),null}return{path:r,params:i}},i.insomnia_to_oas_params=function(t,e){for(var r,a=[],i=n(t);!(r=i()).done;){var s=r.value;if(s.name&&""!=s.name){var u=o(s.name,this.envVars),c=o(s.value,this.envVars),l={name:u,in:e,example:c,schema:this._get_schema(c)};a.push(l)}}return a},i._get_oas_query_params_from_url=function(t){var e=[];try{for(var r,a=n(u(t).searchParams);!(r=a()).done;){var i=r.value,o=i[1];e.push({name:decodeURIComponent(i[0]),value:decodeURIComponent(o)})}}catch(t){}finally{return this.insomnia_to_oas_params(e,"query")}},i._get_schema=function(t){return function(t,e){if(null==t)return{};var r,n,a={},i=Object.keys(t);for(n=0;n<i.length;n++)e.indexOf(r=i[n])>=0||(a[r]=t[r]);return a}(h.json("insomnia",t),["title","$schema"])},i.get_spec=function(){return new p(this.builder)},r}();exports.default=function(){function t(t,e){this.config={title:"Api",description:"",version:"1.0.0",baseUrl:"http://example.tld"},this.validated=!1,this.validationResult={},this.json={_type:"export",__export_format:4,__export_date:(new Date).toString(),__export_source:"openapi-converter-plugin",resources:[]},this.json=t,this.config=this.getConfig(e),this.validated=!1,this.validationResult={}}var r=t.prototype;return r.getConfig=function(t){return t=Object.assign({},t||{}),e({},this.config,t)},r.getInsomniaResources=function(){return this.sortInsomniaResources(this.json.resources)},r.sortInsomniaResources=function(t){var e=t.filter((function(t){return"environment"==t._type})),r=t.filter((function(t){return"request"==t._type})),n=t.filter((function(t){return"request_group"==t._type})),a=t.filter((function(t){return"workspace"==t._type})),i=t.filter((function(t){return"cookie_jar"==t._type})),o=t.filter((function(t){return"api_spec"==t._type}));return[].concat(e,r,n,a,i,o)},r.convert=function(){this.collector=new d,this.collector.addInfo(this.config);for(var t,e=this.getInsomniaResources(),r=n(e);!(t=r()).done;){var a=t.value;if("request_group"==a._type){var o=i(a,e);null!==o&&this.collector.addFolderToRequest(a,o)}if("environment"==a._type&&this.collector.addEnvironment(a),"request"==a._type)try{this.collector.addRequest(a)}catch(t){return this.validationResult={result:!1,reason:t},null}}return this.collector.get_spec()},t}();
//# sourceMappingURL=insomnia-openapi-converter.cjs.production.min.js.map
